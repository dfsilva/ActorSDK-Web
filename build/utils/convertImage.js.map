{"version":3,"sources":["../../src/utils/convertImage.js"],"names":["loadImage","src","Promise","resolve","reject","xhr","XMLHttpRequest","overrideMimeType","setRequestHeader","addEventListener","binary","responseText","split","map","e","String","fromCharCode","charCodeAt","join","open","send","binaryToArray","result","Array","i","length","push","convertWebPText","data","buff","decoder","WebPDecoder","config","WebPDecoderConfig","output_buffer","j","bitstream","input","WebPInitDecoderConfig","Error","status","WebPGetFeatures","J","WebPDecode","bitmap","c","RGBA","ma","height","width","canvas","document","createElement","context","getContext","convertWebPToPNG","then","webp","output","createImageData","outputData","h","w","putImageData","toDataURL","isWebPSupported","image","Image","onload","onerror","isSupported","require","ensure","convertImage","test"],"mappings":"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","file":"convertImage.js","sourcesContent":["/* global WebPDecoder */\r\nimport { memoize } from 'lodash';\r\n\r\nfunction loadImage(src) {\r\n  return new Promise(function (resolve, reject) {\r\n    var xhr = new XMLHttpRequest();\r\n    if (xhr.overrideMimeType) {\r\n      xhr.overrideMimeType('text/plain; charset=x-user-defined');\r\n    } else {\r\n      xhr.setRequestHeader('Accept-Charset', 'x-user-defined');\r\n    }\r\n\r\n    xhr.addEventListener('error', reject);\r\n    xhr.addEventListener('load', function () {\r\n      var binary = xhr.responseText.split('').map(function (e) {\r\n        return String.fromCharCode(e.charCodeAt(0) & 0xff);\r\n      }).join('');\r\n      resolve(binary);\r\n    });\r\n\r\n    xhr.open('GET', src);\r\n    xhr.send();\r\n  });\r\n}\r\n\r\nfunction binaryToArray(binary) {\r\n  var result = new Array();\r\n  for (var i = 0; i < binary.length; i++) {\r\n    result.push(binary.charCodeAt(i));\r\n  }\r\n\r\n  return result;\r\n}\r\n\r\nfunction convertWebPText(data) {\r\n  var buff = binaryToArray(data);\r\n\r\n  var decoder = new WebPDecoder();\r\n  var config = decoder.WebPDecoderConfig;\r\n  var output_buffer = config.j;\r\n  var bitstream = config.input;\r\n\r\n  if (!decoder.WebPInitDecoderConfig(config)) {\r\n    throw new Error('Library version mismatch!');\r\n  }\r\n\r\n  var status = decoder.WebPGetFeatures(buff, buff.length, bitstream);\r\n  if (status !== 0) {\r\n    throw new Error('Unable to decode webp image!', status);\r\n  }\r\n\r\n  output_buffer.J = 4;\r\n  status = decoder.WebPDecode(buff, buff.length, config);\r\n\r\n  if (status != 0) {\r\n    throw new Error('WebP decoding failed.', status);\r\n  }\r\n\r\n  return {\r\n    bitmap: output_buffer.c.RGBA.ma,\r\n    height: output_buffer.height,\r\n    width: output_buffer.width\r\n  };\r\n}\r\n\r\nvar canvas = document.createElement('canvas');\r\nvar context = canvas.getContext('2d');\r\n\r\nfunction convertWebPToPNG(src) {\r\n  return loadImage(src).then(function (data) {\r\n    const webp = convertWebPText(data);\r\n    canvas.height = webp.height;\r\n    canvas.width = webp.width;\r\n\r\n    var output = context.createImageData(canvas.width, canvas.height);\r\n    var outputData = output.data;\r\n\r\n    for (var h = 0; h < webp.height; h++) {\r\n      for (var w = 0; w < webp.width; w++) {\r\n        outputData[0 + w * 4 + webp.width * 4 * h] = webp.bitmap[1 + w * 4 + webp.width * 4 * h];\r\n        outputData[1 + w * 4 + webp.width * 4 * h] = webp.bitmap[2 + w * 4 + webp.width * 4 * h];\r\n        outputData[2 + w * 4 + webp.width * 4 * h] = webp.bitmap[3 + w * 4 + webp.width * 4 * h];\r\n        outputData[3 + w * 4 + webp.width * 4 * h] = webp.bitmap[0 + w * 4 + webp.width * 4 * h];\r\n      }\r\n    }\r\n\r\n    context.putImageData(output, 0, 0);\r\n    return canvas.toDataURL();\r\n  })\r\n}\r\n\r\nconst isWebPSupported = new Promise((resolve) => {\r\n  var image = new Image();\r\n  image.onload = () => resolve(image.width === 2 && image.height === 1);\r\n  image.onerror = () => resolve(false);\r\n  image.src = 'data:image/webp;base64,UklGRjIAAABXRUJQVlA4ICYAAACyAgCdASoCAAEALmk0mk0iIiIiIgBoSygABc6zbAAA/v56QAAAAA==';\r\n}).then((isSupported) => {\r\n  if (isSupported) {\r\n    return true;\r\n  }\r\n\r\n  return new Promise((resolve) => {\r\n    require.ensure(['../vendor/libwebp-0.2.0.min'], (require) => {\r\n      require('../vendor/libwebp-0.2.0.min');\r\n      resolve(false);\r\n    });\r\n  });\r\n})\r\n\r\nfunction convertImage(src) {\r\n  return isWebPSupported.then((isSupported) => {\r\n    if (isSupported || !/\\.webp\\?/.test(src)) {\r\n      return src;\r\n    }\r\n\r\n    return convertWebPToPNG(src);\r\n  });\r\n}\r\n\r\nexport default memoize(convertImage);\r\n"]}