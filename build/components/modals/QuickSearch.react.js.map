{"version":3,"sources":["../../../src/components/modals/QuickSearch.react.js"],"names":["RESULT_ITEM_HEIGHT","scrollIndex","QuickSearch","getStores","calculateState","list","getState","selectedIndex","props","context","setFocus","bind","handleClose","handleSearch","handleDialogSelect","handleKeyDown","handleScroll","componentDidMount","setListeners","componentWillUnmount","cleanListeners","listeners","listen","document","forEach","listener","remove","setImmediate","refs","query","focus","hide","event","setState","target","value","peer","peerStr","peerToString","push","state","results","getResults","visibleItems","index","keyCode","ENTER","stopPropagation","preventDefault","peerInfo","ARROW_UP","length","ARROW_DOWN","TAB","top","scrollTop","filter","result","score","title","userName","renderResults","map","resultClassName","avatar","placeholder","renderHeader","renderSearchInput","intl","messages","render","contextTypes","object","isRequired","create","pure"],"mappings":"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","file":"QuickSearch.react.js","sourcesContent":["/*\r\n * Copyright (C) 2015-2016 Actor LLC. <https://actor.im>\r\n */\r\n\r\nimport React, { Component, PropTypes } from 'react';\r\nimport { findDOMNode } from 'react-dom';\r\nimport { Container } from 'flux/utils';\r\nimport { FormattedMessage, FormattedHTMLMessage } from 'react-intl';\r\nimport EventListener from 'fbjs/lib/EventListener';\r\nimport fuzzaldrin from 'fuzzaldrin';\r\nimport Modal from 'react-modal';\r\nimport classnames from 'classnames';\r\nimport history from '../../utils/history';\r\nimport PeerUtils from '../../utils/PeerUtils';\r\n\r\nimport { KeyCodes } from '../../constants/ActorAppConstants';\r\n\r\nimport QuickSearchActionCreators from '../../actions/QuickSearchActionCreators';\r\n\r\nimport QuickSearchStore from '../../stores/QuickSearchStore';\r\n\r\nimport AvatarItem from '../common/AvatarItem.react';\r\n\r\nconst RESULT_ITEM_HEIGHT = 44;\r\nlet scrollIndex = 0;\r\n\r\nclass QuickSearch extends Component {\r\n  static getStores() {\r\n    return [QuickSearchStore];\r\n  }\r\n\r\n  static calculateState() {\r\n    return {\r\n      list: QuickSearchStore.getState(),\r\n      selectedIndex: 0\r\n    }\r\n  }\r\n\r\n  static contextTypes = {\r\n    intl: PropTypes.object.isRequired\r\n  }\r\n\r\n  constructor(props, context) {\r\n    super(props, context);\r\n\r\n    this.setFocus = this.setFocus.bind(this);\r\n    this.handleClose = this.handleClose.bind(this);\r\n    this.handleSearch = this.handleSearch.bind(this);\r\n    this.handleDialogSelect = this.handleDialogSelect.bind(this);\r\n    this.handleKeyDown = this.handleKeyDown.bind(this);\r\n    this.handleScroll = this.handleScroll.bind(this);\r\n  }\r\n\r\n  componentDidMount() {\r\n    this.setFocus();\r\n    this.setListeners();\r\n  }\r\n\r\n  componentWillUnmount() {\r\n    this.cleanListeners();\r\n  }\r\n\r\n  setListeners() {\r\n    this.cleanListeners();\r\n    this.listeners = [\r\n      EventListener.listen(document, 'keydown', this.handleKeyDown)\r\n    ];\r\n  }\r\n\r\n  cleanListeners() {\r\n    if (this.listeners) {\r\n      this.listeners.forEach((listener) => listener.remove());\r\n      this.listeners = null;\r\n    }\r\n  }\r\n\r\n  setFocus() {\r\n    setImmediate(() => findDOMNode(this.refs.query).focus());\r\n  }\r\n\r\n  handleClose() {\r\n    QuickSearchActionCreators.hide();\r\n  }\r\n\r\n  handleSearch(event) {\r\n    this.setState({ query: event.target.value });\r\n  }\r\n\r\n  handleDialogSelect(peer) {\r\n    const peerStr = PeerUtils.peerToString(peer);\r\n    history.push(`/im/${peerStr}`);\r\n    this.handleClose();\r\n  }\r\n\r\n  handleKeyDown(event) {\r\n    const { selectedIndex } = this.state;\r\n    const results = this.getResults();\r\n    const visibleItems = 8;\r\n    let index = selectedIndex;\r\n\r\n    switch (event.keyCode) {\r\n      case KeyCodes.ENTER:\r\n        event.stopPropagation();\r\n        event.preventDefault();\r\n        this.handleDialogSelect(results[selectedIndex].peerInfo.peer);\r\n        break;\r\n\r\n      case KeyCodes.ARROW_UP:\r\n        event.stopPropagation();\r\n        event.preventDefault();\r\n\r\n        if (index > 0) {\r\n          index -= 1;\r\n        } else if (index === 0) {\r\n          index = results.length - 1;\r\n        }\r\n\r\n        if (scrollIndex > index) {\r\n          scrollIndex = index;\r\n        } else if (index === results.length - 1) {\r\n          scrollIndex = results.length - visibleItems;\r\n        }\r\n\r\n        this.handleScroll(scrollIndex * RESULT_ITEM_HEIGHT);\r\n        this.setState({ selectedIndex: index });\r\n        break;\r\n      case KeyCodes.ARROW_DOWN:\r\n      case KeyCodes.TAB:\r\n        event.stopPropagation();\r\n        event.preventDefault();\r\n\r\n        if (index < results.length - 1) {\r\n          index += 1;\r\n        } else if (index === results.length - 1) {\r\n          index = 0;\r\n        }\r\n\r\n        if (index + 1 > scrollIndex + visibleItems) {\r\n          scrollIndex = index + 1 - visibleItems;\r\n        } else if (index === 0) {\r\n          scrollIndex = 0;\r\n        }\r\n\r\n        this.handleScroll(scrollIndex * RESULT_ITEM_HEIGHT);\r\n        this.setState({ selectedIndex: index });\r\n        break;\r\n\r\n      default:\r\n    }\r\n  }\r\n\r\n  handleScroll(top) {\r\n    findDOMNode(this.refs.results).scrollTop = top;\r\n  }\r\n\r\n  getResults() {\r\n    const { list, query } = this.state;\r\n    if (!query || query === '') return list;\r\n\r\n    return list.filter((result) => {\r\n      return fuzzaldrin.score(result.peerInfo.title, query) > 0 ||\r\n             fuzzaldrin.score(result.peerInfo.userName, query) > 0;\r\n    });\r\n  }\r\n\r\n  renderResults() {\r\n    const { selectedIndex, query } = this.state;\r\n    const results = this.getResults();\r\n\r\n    if (!results.length) {\r\n      return (\r\n        <li className=\"results__item results__item--suggestion row\">\r\n          <FormattedHTMLMessage id=\"modal.quickSearch.notFound\" values={{ query }}/>\r\n          <button className=\"button button--rised hide\">Create new dialog {query}</button>\r\n        </li>\r\n      )\r\n    }\r\n\r\n    return results.map((result, index) => {\r\n      const resultClassName = classnames('results__item row', {\r\n        'results__item--active': selectedIndex === index\r\n      });\r\n\r\n      return (\r\n        <li\r\n          className={resultClassName} key={`r${index}`}\r\n          onClick={() => this.handleDialogSelect(result.peerInfo.peer)}\r\n          onMouseOver={() => this.setState({ selectedIndex: index })}>\r\n          <AvatarItem\r\n            className=\"quick-search__avatar\"\r\n            size=\"small\"\r\n            image={result.peerInfo.avatar}\r\n            placeholder={result.peerInfo.placeholder}\r\n            title={result.peerInfo.title}\r\n          />\r\n          <div className=\"title col-xs\">\r\n            <div className=\"hint pull-right\"><FormattedMessage id=\"modal.quickSearch.openDialog\"/></div>\r\n            {result.peerInfo.title}\r\n          </div>\r\n        </li>\r\n      );\r\n    });\r\n  }\r\n\r\n  renderHeader() {\r\n    return (\r\n      <header className=\"header\">\r\n        <div className=\"pull-left\"><FormattedMessage id=\"modal.quickSearch.title\"/></div>\r\n        <div className=\"pull-right\"><strong>esc</strong>&nbsp; <FormattedMessage id=\"modal.quickSearch.toClose\"/></div>\r\n        <div className=\"pull-right\"><strong>↵</strong>&nbsp; <FormattedMessage id=\"modal.quickSearch.toSelect\"/></div>\r\n        <div className=\"pull-right\"><strong>tab</strong>&nbsp; or &nbsp;<strong>↑</strong><strong>↓</strong>&nbsp; <FormattedMessage id=\"modal.quickSearch.toNavigate\"/></div>\r\n      </header>\r\n    );\r\n  }\r\n\r\n  renderSearchInput() {\r\n    const { query } = this.state;\r\n    const { intl } = this.context;\r\n\r\n    return (\r\n      <div className=\"large-search\">\r\n        <input\r\n          className=\"input\"\r\n          type=\"text\"\r\n          placeholder={intl.messages['modal.quickSearch.placeholder']}\r\n          onChange={this.handleSearch}\r\n          value={query}\r\n          ref=\"query\"/>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  render() {\r\n    return (\r\n      <Modal\r\n        overlayClassName=\"modal-overlay\"\r\n        className=\"modal\"\r\n        onRequestClose={this.handleClose}\r\n        isOpen>\r\n\r\n        <div className=\"quick-search\">\r\n          <div className=\"modal__content\">\r\n\r\n            {this.renderHeader()}\r\n\r\n            {this.renderSearchInput()}\r\n\r\n            <ul className=\"results\" ref=\"results\">\r\n              {this.renderResults()}\r\n            </ul>\r\n\r\n          </div>\r\n        </div>\r\n\r\n      </Modal>\r\n    );\r\n  }\r\n}\r\n\r\nexport default Container.create(QuickSearch, { pure: false });\r\n"]}