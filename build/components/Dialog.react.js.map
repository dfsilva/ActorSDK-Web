{"version":3,"sources":["../../src/components/Dialog.react.js"],"names":["Dialog","getStores","calculateState","peer","getCurrentPeer","dialogInfo","getState","uid","getMyId","isMember","isActivityOpen","isOpen","message","getMessage","isFavorite","id","call","calculateCallState","search","equals","isCalling","props","context","updatePeer","params","handleStartClick","bind","handleUnblock","handleDialogSearchCancel","handleDialogSearchChange","components","getComponents","componentWillReceiveProps","nextProps","componentWillUnmount","selectDialogPeer","stringToPeer","hasPeer","replace","state","sendTextMessage","unblockUser","query","setQuery","close","getActivityComponents","get","features","dialog","activity","calls","push","DialogHeader","header","MessagesSection","messages","DialogFooter","footer","renderActivities","map","Activity","index","renderDialogSearch","renderContent","results","isSearching","render","propTypes","shape","string","isRequired","create","withProps"],"mappings":"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","file":"Dialog.react.js","sourcesContent":["/*\r\n * Copyright (C) 2015-2016 Actor LLC. <https://actor.im>\r\n */\r\n\r\nimport { isFunction } from 'lodash';\r\nimport React, { Component, PropTypes } from 'react';\r\nimport { Container } from 'flux/utils';\r\nimport DelegateContainer from '../utils/DelegateContainer';\r\n\r\nimport PeerUtils from '../utils/PeerUtils';\r\nimport history from '../utils/history';\r\n\r\nimport DefaultMessages from './dialog/MessagesSection.react';\r\nimport DefaultDialogHeader from './dialog/DialogHeader.react';\r\nimport DefaultDialogFooter from './dialog/DialogFooter.react';\r\nimport DefaultActivity from './Activity.react';\r\nimport DefaultCall from './Call.react';\r\nimport DialogSearch from './search/DialogSearch.react';\r\nimport SearchResults from './search/SearchResults.react';\r\n\r\nimport UserStore from '../stores/UserStore';\r\nimport DialogStore from '../stores/DialogStore';\r\nimport DialogInfoStore from '../stores/DialogInfoStore';\r\nimport ActivityStore from '../stores/ActivityStore';\r\nimport OnlineStore from '../stores/OnlineStore';\r\nimport CallStore from '../stores/CallStore';\r\nimport SearchMessagesStore from '../stores/SearchMessagesStore'\r\n\r\nimport DialogActionCreators from '../actions/DialogActionCreators';\r\nimport MessageActionCreators from '../actions/MessageActionCreators';\r\nimport BlockedUsersActionCreators from '../actions/BlockedUsersActionCreators';\r\nimport SearchMessagesActionCreators from '../actions/SearchMessagesActionCreators';\r\n\r\nclass Dialog extends Component {\r\n  static propTypes = {\r\n    params: PropTypes.shape({\r\n      id: PropTypes.string.isRequired\r\n    }).isRequired\r\n  };\r\n\r\n  static getStores() {\r\n    return [ActivityStore, DialogStore, DialogInfoStore, OnlineStore, CallStore, SearchMessagesStore];\r\n  }\r\n\r\n  static calculateState() {\r\n    const peer = DialogStore.getCurrentPeer();\r\n    const dialogInfo = DialogInfoStore.getState();\r\n\r\n    return {\r\n      peer,\r\n      dialogInfo,\r\n      uid: UserStore.getMyId(),\r\n      isMember: DialogStore.isMember(),\r\n      isActivityOpen: ActivityStore.isOpen(),\r\n      message: OnlineStore.getMessage(),\r\n      isFavorite: DialogStore.isFavorite(peer ? peer.id : 0),\r\n      call: Dialog.calculateCallState(peer),\r\n      search: SearchMessagesStore.getState()\r\n    };\r\n  }\r\n\r\n  static calculateCallState(peer) {\r\n    const call = CallStore.getState();\r\n\r\n    if (!call.isOpen || !PeerUtils.equals(peer, call.peer)) {\r\n      return {\r\n        isCalling: false\r\n      };\r\n    }\r\n\r\n    return {\r\n      ...call,\r\n      isCalling: true\r\n    };\r\n  }\r\n\r\n  constructor(props, context) {\r\n    super(props, context);\r\n    this.updatePeer(this.props.params.id);\r\n\r\n    this.handleStartClick = this.handleStartClick.bind(this);\r\n    this.handleUnblock = this.handleUnblock.bind(this);\r\n    this.handleDialogSearchCancel = this.handleDialogSearchCancel.bind(this);\r\n    this.handleDialogSearchChange = this.handleDialogSearchChange.bind(this);\r\n\r\n    this.components = this.getComponents();\r\n  }\r\n\r\n  componentWillReceiveProps(nextProps) {\r\n    if (nextProps.params.id !== this.props.params.id) {\r\n      this.updatePeer(nextProps.params.id);\r\n    }\r\n  }\r\n\r\n  componentWillUnmount() {\r\n    DialogActionCreators.selectDialogPeer(null);\r\n  }\r\n\r\n  updatePeer(id) {\r\n    const peer = PeerUtils.stringToPeer(id);\r\n    if (PeerUtils.hasPeer(peer)) {\r\n      DialogActionCreators.selectDialogPeer(peer);\r\n    } else {\r\n      history.replace('/im');\r\n    }\r\n  }\r\n\r\n  handleStartClick() {\r\n    const { peer } = this.state;\r\n    MessageActionCreators.sendTextMessage(peer, '/start');\r\n  }\r\n\r\n  handleUnblock() {\r\n    const { dialogInfo } = this.state;\r\n    BlockedUsersActionCreators.unblockUser(dialogInfo.id);\r\n  }\r\n\r\n  handleDialogSearchChange(query) {\r\n    SearchMessagesActionCreators.setQuery(query);\r\n  }\r\n\r\n  handleDialogSearchCancel() {\r\n    SearchMessagesActionCreators.close();\r\n  }\r\n\r\n  getActivityComponents() {\r\n    const { features, components } = DelegateContainer.get();\r\n    const { dialog } = components;\r\n\r\n    if (dialog && dialog.activity) {\r\n      return dialog.activity;\r\n    }\r\n\r\n    const activity = [DefaultActivity];\r\n    if (features.calls) {\r\n      activity.push(DefaultCall);\r\n    }\r\n\r\n    return activity;\r\n  }\r\n\r\n  getComponents() {\r\n    const { components: { dialog } } = DelegateContainer.get();\r\n    const activity = this.getActivityComponents();\r\n\r\n    if (dialog && !isFunction(dialog)) {\r\n      return {\r\n        activity,\r\n        DialogHeader: isFunction(dialog.header) ? dialog.header : DefaultDialogHeader,\r\n        MessagesSection: isFunction(dialog.messages) ? dialog.messages : DefaultMessages,\r\n        DialogFooter: isFunction(dialog.footer) ? dialog.footer : DefaultDialogFooter\r\n      };\r\n    }\r\n\r\n    return {\r\n      activity,\r\n      DialogHeader: DefaultDialogHeader,\r\n      MessagesSection: DefaultMessages,\r\n      DialogFooter: DefaultDialogFooter\r\n    };\r\n  }\r\n\r\n  renderActivities() {\r\n    const { activity } = this.components;\r\n    return activity.map((Activity, index) => <Activity key={index} />)\r\n  }\r\n\r\n  renderDialogSearch() {\r\n    const { search } = this.state;\r\n\r\n    return (\r\n      <DialogSearch\r\n        isOpen={search.isOpen}\r\n        query={search.query}\r\n        onCancel={this.handleDialogSearchCancel}\r\n        onChange={this.handleDialogSearchChange}\r\n      />\r\n    )\r\n  }\r\n\r\n  renderContent() {\r\n    const { uid, peer, isMember, dialogInfo, search } = this.state;\r\n    const { MessagesSection, DialogFooter } = this.components;\r\n\r\n    if (search.isOpen) {\r\n      return (\r\n        <SearchResults\r\n          query={search.query}\r\n          results={search.results}\r\n          isSearching={search.isSearching}\r\n        />\r\n      );\r\n    }\r\n\r\n    return (\r\n      <div className=\"chat\">\r\n        <MessagesSection\r\n          uid={uid}\r\n          peer={peer}\r\n          isMember={isMember}\r\n        />\r\n        <DialogFooter\r\n          info={dialogInfo}\r\n          isMember={isMember}\r\n          onUnblock={this.handleUnblock}\r\n          onStart={this.handleStartClick}\r\n        />\r\n      </div>\r\n    );\r\n  }\r\n\r\n  render() {\r\n    const { peer, dialogInfo, message, isFavorite, call, isActivityOpen, search } = this.state;\r\n    const { DialogHeader } = this.components;\r\n\r\n    if (!peer) {\r\n      return <section className=\"main\" />;\r\n    }\r\n\r\n    return (\r\n      <section className=\"main\">\r\n        <DialogHeader\r\n          info={dialogInfo}\r\n          message={message}\r\n          call={call}\r\n          peer={peer}\r\n          isFavorite={isFavorite}\r\n          isDialogSearchOpen={search.isOpen}\r\n          isActivityOpen={isActivityOpen}\r\n        />\r\n        {this.renderDialogSearch()}\r\n        <div className=\"flexrow\">\r\n          <section className=\"dialog\">\r\n            {this.renderContent()}\r\n          </section>\r\n          {this.renderActivities()}\r\n        </div>\r\n      </section>\r\n    );\r\n  }\r\n}\r\n\r\nexport default Container.create(Dialog, { withProps: true });\r\n"]}