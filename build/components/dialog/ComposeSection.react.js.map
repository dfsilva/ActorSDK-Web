{"version":3,"sources":["../../../src/components/dialog/ComposeSection.react.js"],"names":["ComposeSection","getStores","calculateState","peer","getCurrentPeer","compose","getState","profile","getUser","getUid","sendByEnter","isSendByEnterEnabled","isMessageArtOpen","isOpen","stickers","props","resetAttachmentForm","form","refs","attachmentForm","reset","onMentionSelect","mention","state","text","insertMention","getCaretPosition","setFocus","onMentionClose","closeMention","handleEmojiSelect","emoji","insertEmoji","handleStickerSelect","sticker","sendSticker","area","focus","handleDrop","files","attachments","file","push","length","show","handleAttachmentClick","attachmentInputNode","attachment","setAttribute","click","handleComposeAttachmentChange","sendVoiceRecord","duration","record","sendVoiceMessage","onTyping","bind","onSubmit","onPaste","onKeyDown","onEditTyping","onEditCancel","onEditSubmit","onEditKeyDown","onCommandSelect","onCommandClose","componentDidUpdate","prevProps","prevState","autoFocus","editMessage","blur","caretPosition","trim","sendTextMessage","cleanText","event","Array","from","clipboardData","items","filter","item","type","indexOf","map","getAsFile","preventDefault","delegate","context","features","editing","keyCode","ARROW_UP","target","value","editLastMessage","editTextMessage","rid","deleteMessage","changeText","ESC","cancelEdit","command","renderCommands","commands","renderMentions","mentions","renderEditing","intl","avatar","placeholder","name","messages","renderPosting","render","contextTypes","object","isRequired","create","pure"],"mappings":"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","file":"ComposeSection.react.js","sourcesContent":["/*\r\n * Copyright (C) 2015-2016 Actor LLC. <https://actor.im>\r\n */\r\n\r\nimport { forEach } from 'lodash';\r\nimport React, { Component, PropTypes } from 'react';\r\nimport { findDOMNode } from 'react-dom';\r\nimport { Container } from 'flux/utils';\r\nimport { FormattedMessage } from 'react-intl';\r\n\r\nimport ActorClient from '../../utils/ActorClient';\r\nimport { KeyCodes } from '../../constants/ActorAppConstants';\r\n\r\nimport MessageActionCreators from '../../actions/MessageActionCreators';\r\nimport ComposeActionCreators from '../../actions/ComposeActionCreators';\r\nimport AttachmentsActionCreators from '../../actions/AttachmentsActionCreators';\r\nimport EmojiActionCreators from '../../actions/EmojiActionCreators';\r\nimport StickersActionCreators from '../../actions/StickersActionCreators';\r\n\r\nimport GroupStore from '../../stores/GroupStore';\r\nimport PreferencesStore from '../../stores/PreferencesStore';\r\nimport ComposeStore from '../../stores/ComposeStore';\r\nimport DialogStore from '../../stores/DialogStore';\r\nimport MessageArtStore from '../../stores/MessageArtStore';\r\n\r\nimport ComposeTextArea from './compose/ComposeTextArea.react';\r\nimport ComposeMarkdownHint from './compose/ComposeMarkdownHint.react';\r\nimport BotCommandsHint from './compose/BotCommandsHint.react';\r\nimport AvatarItem from '../common/AvatarItem.react';\r\nimport MentionDropdown from '../common/MentionDropdown.react';\r\nimport MessageArt from '../messageArt/MessageArt.react';\r\nimport VoiceRecorder from '../common/VoiceRecorder.react';\r\nimport DropZone from '../common/DropZone.react';\r\n\r\nclass ComposeSection extends Component {\r\n  static contextTypes = {\r\n    intl: PropTypes.object.isRequired,\r\n    delegate: PropTypes.object.isRequired\r\n  };\r\n\r\n  static getStores() {\r\n    return [DialogStore, GroupStore, PreferencesStore, ComposeStore, MessageArtStore];\r\n  }\r\n\r\n  static calculateState() {\r\n    return {\r\n      peer: DialogStore.getCurrentPeer(),\r\n      compose: ComposeStore.getState(),\r\n      profile: ActorClient.getUser(ActorClient.getUid()),\r\n      sendByEnter: PreferencesStore.isSendByEnterEnabled(),\r\n      isMessageArtOpen: MessageArtStore.getState().isOpen,\r\n      stickers: MessageArtStore.getState().stickers\r\n    };\r\n  }\r\n\r\n  constructor(props) {\r\n    super(props);\r\n\r\n    this.onTyping = this.onTyping.bind(this);\r\n    this.onSubmit = this.onSubmit.bind(this);\r\n    this.onPaste = this.onPaste.bind(this);\r\n    this.onKeyDown = this.onKeyDown.bind(this);\r\n    this.onEditTyping = this.onEditTyping.bind(this);\r\n    this.onEditCancel = this.onEditCancel.bind(this);\r\n    this.onEditSubmit = this.onEditSubmit.bind(this);\r\n    this.onEditKeyDown = this.onEditKeyDown.bind(this);\r\n    this.onCommandSelect = this.onCommandSelect.bind(this);\r\n    this.onCommandClose = this.onCommandClose.bind(this);\r\n  }\r\n\r\n  componentDidUpdate(prevProps, prevState) {\r\n    if (prevState.peer !== this.state.peer) {\r\n      this.refs.area.autoFocus();\r\n    } else if (prevState.compose.editMessage !== this.state.compose.editMessage) {\r\n      this.refs.area.blur();\r\n      this.refs.area.focus(true);\r\n    }\r\n  }\r\n\r\n  onTyping(text, caretPosition) {\r\n    ComposeActionCreators.onTyping(this.state.peer, text, caretPosition);\r\n  }\r\n\r\n  onSubmit() {\r\n    const { peer, compose: { text } } = this.state;\r\n\r\n    if (text.trim().length) {\r\n      MessageActionCreators.sendTextMessage(peer, text);\r\n    }\r\n\r\n    ComposeActionCreators.cleanText();\r\n  }\r\n\r\n  onPaste(event) {\r\n    const attachments = Array.from(event.clipboardData.items)\r\n      .filter((item) => item.type.indexOf('image') !== -1)\r\n      .map((item) => item.getAsFile());\r\n\r\n    if (attachments.length) {\r\n      event.preventDefault();\r\n      AttachmentsActionCreators.show(attachments);\r\n    }\r\n  }\r\n\r\n  onKeyDown(event) {\r\n    const { delegate } = this.context;\r\n    if (delegate.features.editing && event.keyCode === KeyCodes.ARROW_UP && !event.target.value) {\r\n      event.preventDefault();\r\n      MessageActionCreators.editLastMessage();\r\n    }\r\n  }\r\n\r\n  onEditSubmit() {\r\n    const { peer, compose: { text, editMessage } } = this.state;\r\n\r\n    if (text) {\r\n      MessageActionCreators.editTextMessage(peer, editMessage.rid, text);\r\n    } else {\r\n      MessageActionCreators.deleteMessage(peer, editMessage.rid);\r\n      ComposeActionCreators.cleanText();\r\n    }\r\n  }\r\n\r\n  onEditTyping(text, caretPosition) {\r\n    ComposeActionCreators.changeText(this.state.peer, text, caretPosition);\r\n  }\r\n\r\n  onEditKeyDown(event) {\r\n    if (event.keyCode === KeyCodes.ESC) {\r\n      event.preventDefault();\r\n      this.onEditCancel();\r\n    }\r\n  }\r\n\r\n  onEditCancel() {\r\n    ComposeActionCreators.cancelEdit();\r\n  }\r\n\r\n  resetAttachmentForm = () => {\r\n    const form = findDOMNode(this.refs.attachmentForm);\r\n    form.reset();\r\n  };\r\n\r\n  // TODO: move this to textarea component\r\n  onMentionSelect = (mention) => {\r\n    const { peer, compose: { text } } = this.state;\r\n\r\n    ComposeActionCreators.insertMention(peer, text, this.getCaretPosition(), mention);\r\n    this.setFocus();\r\n  };\r\n\r\n  onMentionClose = () => {\r\n    ComposeActionCreators.closeMention();\r\n  };\r\n\r\n  // TODO: move this to textarea component\r\n  handleEmojiSelect = (emoji) => {\r\n    const { compose: { text } } = this.state;\r\n    EmojiActionCreators.insertEmoji(text, this.getCaretPosition(), emoji);\r\n    this.setFocus();\r\n  };\r\n\r\n  onCommandSelect(command) {\r\n    const { peer } = this.state;\r\n    MessageActionCreators.sendTextMessage(peer, `/${command}`);\r\n    ComposeActionCreators.cleanText();\r\n  }\r\n\r\n  onCommandClose() {\r\n    ComposeActionCreators.cleanText();\r\n  }\r\n\r\n  handleStickerSelect = (sticker) => {\r\n    const { peer } = this.state;\r\n    StickersActionCreators.sendSticker(peer, sticker);\r\n    this.setFocus();\r\n  };\r\n\r\n  setFocus = () => {\r\n    findDOMNode(this.refs.area).focus();\r\n  };\r\n\r\n  handleDrop = (files) => {\r\n    let attachments = [];\r\n\r\n    forEach(files, (file) => attachments.push(file));\r\n\r\n    if (attachments.length > 0) {\r\n      AttachmentsActionCreators.show(attachments);\r\n    }\r\n  };\r\n\r\n  handleAttachmentClick = () => {\r\n    const attachmentInputNode = findDOMNode(this.refs.attachment);\r\n    attachmentInputNode.setAttribute('multiple', true);\r\n    attachmentInputNode.click();\r\n  };\r\n\r\n  handleComposeAttachmentChange = () => {\r\n    const attachmentInputNode = findDOMNode(this.refs.attachment);\r\n    let attachments = [];\r\n\r\n    forEach(attachmentInputNode.files, (file) => attachments.push(file));\r\n\r\n    AttachmentsActionCreators.show(attachments);\r\n    this.resetAttachmentForm();\r\n  };\r\n\r\n  sendVoiceRecord = (duration, record) => {\r\n    const { peer } = this.state;\r\n    MessageActionCreators.sendVoiceMessage(peer, duration, record);\r\n  };\r\n\r\n  // TODO: remove this method\r\n  getCaretPosition() {\r\n    if (this.refs.area) {\r\n      return this.refs.area.getCaretPosition();\r\n    }\r\n    return 0;\r\n  }\r\n\r\n  renderCommands() {\r\n    const { compose } = this.state;\r\n    if (!compose.commands) {\r\n      return null;\r\n    }\r\n\r\n    return (\r\n      <BotCommandsHint\r\n        commands={compose.commands}\r\n        onSelect={this.onCommandSelect}\r\n        onClose={this.onCommandClose}\r\n      />\r\n    );\r\n  }\r\n\r\n  renderMentions() {\r\n    const { compose } = this.state;\r\n    if (!compose.mentions) {\r\n      return null;\r\n    }\r\n\r\n    return (\r\n      <MentionDropdown\r\n        mentions={compose.mentions}\r\n        onSelect={this.onMentionSelect}\r\n        onClose={this.onMentionClose}\r\n      />\r\n    );\r\n  }\r\n\r\n  renderEditing() {\r\n    const { compose, profile, stickers, isMessageArtOpen, sendByEnter } = this.state;\r\n    const { intl } = this.context;\r\n\r\n    return (\r\n      <section className=\"compose compose--editing\">\r\n\r\n        {this.renderMentions()}\r\n        {this.renderCommands()}\r\n\r\n        <MessageArt\r\n          onSelect={this.handleEmojiSelect}\r\n          onStickerSelect={this.handleStickerSelect}\r\n          isActive={isMessageArtOpen}\r\n          stickers={stickers}\r\n        />\r\n\r\n        <AvatarItem\r\n          className=\"my-avatar\"\r\n          image={profile.avatar}\r\n          placeholder={profile.placeholder}\r\n          title={profile.name}\r\n        />\r\n\r\n        <ComposeMarkdownHint isActive={compose.text.length >= 3} />\r\n        <ComposeTextArea\r\n          autoFocus\r\n          ref=\"area\"\r\n          value={compose.text}\r\n          sendByEnter={sendByEnter}\r\n          sendEnabled={!compose.mentions && !compose.commands}\r\n          onTyping={this.onEditTyping}\r\n          onSubmit={this.onEditSubmit}\r\n          onKeyDown={this.onEditKeyDown}\r\n        />\r\n\r\n        <footer className=\"compose__footer row\">\r\n          <span className=\"col-xs\"/>\r\n          <p className=\"compose__edit-title\">\r\n            <FormattedMessage id=\"compose.editTitle\" />\r\n          </p>\r\n          <button className=\"button button--cancel\" onClick={this.onEditCancel}>\r\n            {intl.messages['compose.cancel']}\r\n          </button>\r\n          <button className=\"button button--lightblue\" onClick={this.onEditSubmit}>\r\n            {intl.messages['compose.edit']}\r\n          </button>\r\n        </footer>\r\n      </section>\r\n    );\r\n  }\r\n\r\n  renderPosting() {\r\n    const { compose, profile, stickers, isMessageArtOpen, sendByEnter } = this.state;\r\n    const { intl } = this.context;\r\n\r\n    return (\r\n      <section className=\"compose\">\r\n\r\n        {this.renderMentions()}\r\n        {this.renderCommands()}\r\n\r\n        <MessageArt\r\n          onSelect={this.handleEmojiSelect}\r\n          onStickerSelect={this.handleStickerSelect}\r\n          isActive={isMessageArtOpen}\r\n          stickers={stickers}\r\n        />\r\n\r\n        <VoiceRecorder onFinish={this.sendVoiceRecord}/>\r\n\r\n        <AvatarItem\r\n          className=\"my-avatar\"\r\n          image={profile.avatar}\r\n          placeholder={profile.placeholder}\r\n          title={profile.name}\r\n        />\r\n\r\n        <ComposeMarkdownHint isActive={compose.text.length >= 3} />\r\n        <ComposeTextArea\r\n          ref=\"area\"\r\n          value={compose.text}\r\n          autoFocus={compose.autoFocus}\r\n          sendByEnter={sendByEnter}\r\n          sendEnabled={!compose.mentions && !compose.commands}\r\n          onTyping={this.onTyping}\r\n          onSubmit={this.onSubmit}\r\n          onPaste={this.onPaste}\r\n          onKeyDown={this.onKeyDown}\r\n        />\r\n\r\n        <DropZone onDropComplete={this.handleDrop}>\r\n          {intl.messages['compose.dropzone']}\r\n        </DropZone>\r\n\r\n        <footer className=\"compose__footer row\">\r\n          <button className=\"button attachment\" onClick={this.handleAttachmentClick}>\r\n            <i className=\"material-icons\">attachment</i> {intl.messages['compose.attach']}\r\n          </button>\r\n          <span className=\"col-xs\"/>\r\n          <button className=\"button button--lightblue\" onClick={this.onSubmit}>\r\n            {intl.messages['compose.send']}\r\n          </button>\r\n        </footer>\r\n\r\n        <form className=\"compose__hidden\" ref=\"attachmentForm\">\r\n          <input ref=\"attachment\" onChange={this.handleComposeAttachmentChange} type=\"file\"/>\r\n        </form>\r\n      </section>\r\n    );\r\n  }\r\n\r\n  render() {\r\n    const { delegate } = this.context;\r\n    const { compose } = this.state;\r\n    if (delegate.features.editing && compose.editMessage) {\r\n      return this.renderEditing();\r\n    }\r\n\r\n    return this.renderPosting();\r\n  }\r\n}\r\n\r\nexport default Container.create(ComposeSection, { pure: false });\r\n"]}